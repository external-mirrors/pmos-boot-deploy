---

# global settings
image: alpine:latest

# defaults for "only"
# We need to run the CI jobs in a "merge request specific context", if CI is
# running in a merge request. Otherwise the environment variable that holds the
# merge request ID is not available. This means, we must set the "only"
# variable accordingly - and if we only do it for one job, all other jobs will
# not get executed. So have the defaults here, and use them in all jobs that
# should run on both the master branch, and in merge requests.
# https://docs.gitlab.com/ee/ci/merge_request_pipelines/index.html#excluding-certain-jobs
.only-default: &only-default
  only:
    - master
    - merge_requests
    - tags

shellcheck:
  allow_failure: true
  <<: *only-default
  before_script:
    - apk -q add shellcheck
  script:
    - .ci/shellcheck.sh

editor-config:
  <<: *only-default
  before_script:
    - adduser -D build
  script:
    - .ci/ec.sh

tests:
  <<: *only-default
  before_script:
#   extract-dtb expects python3 version same as in postmarketos.
    - apk add python3 --repository=https://dl-cdn.alpinelinux.org/alpine/edge/main --allow-untrusted -f -l
    - |
      apk -q add mkbootimg-osm0sis dtc extract-dtb \
      --repository=http://mirror.postmarketos.org/postmarketos/master \
      --allow-untrusted
  script:
    - ./test_boot_deploy_functions.sh
  artifacts:
    expire_in: 1 week
